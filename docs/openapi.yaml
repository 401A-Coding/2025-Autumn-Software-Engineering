openapi: 3.1.0
info:
  title: Quwan Chess API (Contract-first v1)
  version: 1.0.0
  description: |
    Contract-first API for Quwan Chess.

    Notes:
    - Planned public endpoints use the prefix /api/v1/... with a unified envelope { code, message, data }.
    - Current dev endpoints implemented in this repo are /user/register and /user/login (no envelope). They are included as legacy for compatibility and will be deprecated once /api/v1/... is adopted.
servers:
  - url: http://localhost:3000
    description: Local development

tags:
  - name: Auth
    description: Authentication and user identity
  - name: Users
    description: User profile and current user

paths:
  /api/v1/auth/register:
    post:
      tags: [Auth]
      summary: Register via phone + password
      operationId: authRegister
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRegisterRequest"
      responses:
        "200":
          description: Registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseAuthTokens"
              examples:
                ok:
                  value:
                    code: 0
                    message: 注册成功
                    data:
                      accessToken: eyJhbGciOi...
                      refreshToken: eyJhbGciOi...
                      expiresIn: 1800
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                invalidPhone:
                  value:
                    code: 1001
                    message: 手机号格式不正确
                    data: null
                phoneTaken:
                  value:
                    code: 1002
                    message: 手机号已被注册
                    data: null
                weakPassword:
                  value:
                    code: 1003
                    message: 密码过于简单
                    data: null
  /api/v1/auth/login:
    post:
      tags: [Auth]
      summary: Login via phone + password
      operationId: authLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLoginRequest"
      responses:
        "200":
          description: Logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseAuthTokens"
              examples:
                ok:
                  value:
                    code: 0
                    message: 登录成功
                    data:
                      accessToken: eyJhbGciOi...
                      refreshToken: eyJhbGciOi...
                      expiresIn: 1800
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                incorrectCredentials:
                  value:
                    code: 401
                    message: 账号或密码错误
                    data: null
                userNotFound:
                  value:
                    code: 401
                    message: 用户不存在或已被禁用
                    data: null
  /api/v1/auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh and rotate tokens
      operationId: authRefresh
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRefreshRequest"
      responses:
        "200":
          description: Refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseAuthTokens"
              examples:
                ok:
                  value:
                    code: 0
                    message: 刷新成功
                    data:
                      accessToken: eyJhbGciOi...
                      refreshToken: eyJhbGciOi...
                      expiresIn: 1800
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                invalidRefresh:
                  value:
                    code: 401
                    message: 刷新令牌无效
                    data: null
                expiredRefresh:
                  value:
                    code: 401
                    message: 刷新令牌已过期
                    data: null
                revoked:
                  value:
                    code: 401
                    message: 刷新令牌已注销
                    data: null
  /api/v1/users/me:
    get:
      tags: [Users]
      summary: Get current user profile
      operationId: usersMe
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
              examples:
                ok:
                  value:
                    code: 0
                    message: success
                    data:
                      id: 1024
                      nickname: 棋友A
                      phone: "13800000000"
                      avatarUrl: null
                      role: USER
                      createdAt: "2025-10-31T12:00:00.000Z"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                unauthorized:
                  value:
                    code: 401
                    message: 未认证或令牌无效
                    data: null
    patch:
      tags: [Users]
      summary: Update current user profile
      operationId: usersMeUpdate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdateRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                nicknameTaken:
                  value:
                    code: 1001
                    message: 昵称已被占用
                    data: null
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                unauthorized:
                  value:
                    code: 401
                    message: 未认证或令牌无效
                    data: null

  /api/v1/auth/sms:
    post:
      tags: [Auth]
      summary: Send SMS code
      operationId: authSms
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SmsRequest"
      responses:
        "200":
          description: SMS sent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseSmsSent"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                invalidPhone:
                  value:
                    code: 1001
                    message: 手机号格式不正确
                    data: null
                rateLimited:
                  value:
                    code: 1004
                    message: 请求过于频繁，请稍后再试
                    data: null

  /api/v1/auth/logout:
    post:
      tags: [Auth]
      summary: Logout current user
      operationId: authLogout
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                unauthorized:
                  value:
                    code: 401
                    message: 未认证或令牌无效
                    data: null

  /api/v1/users/{userId}:
    get:
      tags: [Users]
      summary: Get other user's profile
      operationId: usersGetById
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                unauthorized:
                  value:
                    code: 401
                    message: 未认证或令牌无效
                    data: null

  /api/v1/users/me/avatar:
    post:
      tags: [Users]
      summary: Upload avatar
      operationId: usersMeAvatar
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: 上传头像文件（仅支持 image/png、image/jpeg、image/webp），建议大小 ≤ 2MB
            encoding:
              file:
                contentType: image/png, image/jpeg, image/webp
      responses:
        "200":
          description: Uploaded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseAvatar"
              examples:
                ok:
                  value:
                    code: 0
                    message: 上传成功
                    data:
                      url: data:image/png;base64,iVBORw0KGgoAAAANSUhEUg...
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                missingFile:
                  value:
                    code: 1001
                    message: 缺少文件
                    data: null
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                unauthorized:
                  value:
                    code: 401
                    message: 未认证或令牌无效
                    data: null

  /api/v1/boards/templates:
    get:
      tags: [Boards]
      summary: List board templates
      operationId: boardsTemplates
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1, minimum: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 10, minimum: 1, maximum: 100 }
      responses:
        "200":
          description: Templates
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePageBoardTemplates"

  /api/v1/boards/standard:
    get:
      tags: [Boards]
      summary: Get standard Xiangqi board definition
      operationId: boardsStandard
      responses:
        "200":
          description: Standard board definition
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBoard"

  /api/v1/boards:
    post:
      tags: [Boards]
      summary: Create board
      operationId: boardsCreate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BoardCreateRequest"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBoardCreateResult"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                invalidRules:
                  value:
                    code: 400
                    message: 参数校验失败
                    data:
                      details:
                        - "rules.pieceRules.general.constraints.palace must be one of [none, insideOnly, outsideOnly]"
                        - "name should not be empty"

  /api/v1/boards/mine:
    get:
      tags: [Boards]
      summary: List my boards
      operationId: boardsMine
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1, minimum: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 10, minimum: 1, maximum: 100 }
      responses:
        "200":
          description: Page of boards
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePageBoards"

  /api/v1/boards/{boardId}:
    get:
      tags: [Boards]
      summary: Get board detail
      operationId: boardsGet
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: boardId
          schema: { type: integer }
      responses:
        "200":
          description: Board
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBoard"
    patch:
      tags: [Boards]
      summary: Update board
      operationId: boardsUpdate
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: boardId
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BoardUpdateRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBoard"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
              examples:
                invalidPatch:
                  value:
                    code: 400
                    message: 参数校验失败
                    data:
                      details:
                        - "rules.ruleVersion must be an integer greater than or equal to 1"
                        - "layout.pieces[0].x must be an integer"
    delete:
      tags: [Boards]
      summary: Delete board
      operationId: boardsDelete
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: boardId
          schema: { type: integer }
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"

  /api/v1/battles:
    post:
      tags: [Battles]
      summary: Create battle
      operationId: battlesCreate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BattleCreateRequest"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBattleCreateResult"

  /api/v1/battles/join:
    post:
      tags: [Battles]
      summary: Join battle
      operationId: battlesJoin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BattleJoinRequest"
      responses:
        "200":
          description: Joined
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBattle"
  /api/v1/battles/match:
    post:
      tags: [Battles]
      summary: Quick match
      operationId: battlesMatch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BattleMatchRequest"
      responses:
        "200":
          description: Matched
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBattleMatchResult"

  /api/v1/battles/history:
    get:
      tags: [Battles]
      summary: Battle history
      operationId: battlesHistory
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 10 }
      responses:
        "200":
          description: History page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePageBattleHistory"

  /api/v1/battles/{battleId}:
    get:
      tags: [Battles]
      summary: Get battle info
      operationId: battlesGet
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: battleId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Battle info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBattle"

  /api/v1/battles/resign:
    post:
      tags: [Battles]
      summary: Resign current battle
      operationId: battlesResign
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [battleId]
              properties:
                battleId:
                  type: integer
                  example: 501
      responses:
        "200":
          description: Resigned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBattle"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseError"
  /api/v1/records:
    get:
      tags: [Records]
      summary: List my records
      operationId: recordsList
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 10 }
        - in: query
          name: favorite
          schema: { type: boolean, nullable: true }
      responses:
        "200":
          description: Records page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePageRecords"
    post:
      tags: [Records]
      summary: Create a record
      operationId: recordsCreate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecordCreateRequest"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseRecord"

  /api/v1/records/{id}:
    get:
      tags: [Records]
      summary: Get record detail
      operationId: recordsGet
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Record
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseRecord"
    patch:
      tags: [Records]
      summary: Update record meta
      operationId: recordsUpdate
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecordUpdateRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
  /api/v1/records/{id}/share:
    post:
      tags: [Records]
      summary: Share record
      operationId: recordsShare
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShareRequest"
      responses:
        "200":
          description: Shared
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseShareResult"
  /api/v1/records/{id}/favorite:
    post:
      tags: [Records]
      summary: Favorite record
      operationId: recordsFavorite
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
    delete:
      tags: [Records]
      summary: Unfavorite record
      operationId: recordsUnfavorite
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
  /api/v1/records/{id}/comments:
    get:
      tags: [Records]
      summary: List comments
      operationId: recordsCommentsList
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Comments
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseComments"
    post:
      tags: [Records]
      summary: Add comment
      operationId: recordsCommentsAdd
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommentCreateRequest"
      responses:
        "200":
          description: Added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseCommentCreate"
  /api/v1/records/{id}/export:
    get:
      tags: [Records]
      summary: Export record file
      operationId: recordsExport
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Binary export
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /api/v1/records/{id}/bookmarks:
    post:
      tags: [Records]
      summary: Add bookmark/note
      operationId: recordsBookmarkAdd
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BookmarkCreateRequest"
      responses:
        "200":
          description: Added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseBookmarkCreate"

  /api/v1/records/{id}/bookmarks/{bid}:
    patch:
      tags: [Records]
      summary: Update bookmark/note
      operationId: recordsBookmarkUpdate
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: path
          name: bid
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BookmarkUpdateRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
    delete:
      tags: [Records]
      summary: Delete bookmark/note
      operationId: recordsBookmarkDelete
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: path
          name: bid
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"

  /api/v1/records/prefs:
    get:
      tags: [Records]
      summary: Get record retention preferences
      operationId: recordsPrefsGet
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Prefs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseRecordPrefs"
    patch:
      tags: [Records]
      summary: Update record retention preferences
      operationId: recordsPrefsUpdate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecordPrefsPatch"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseRecordPrefs"

  /api/v1/community/posts:
    get:
      tags: [Community]
      summary: List community posts (feed)
      operationId: communityPostsList
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20 }
        - in: query
          name: q
          description: Full-text query
          schema: { type: string }
        - in: query
          name: tag
          schema: { type: string }
        - in: query
          name: type
          description: Filter by share type (record|board|clip|none)
          schema: { type: string }
        - in: query
          name: authorId
          schema: { type: integer }
        - in: query
          name: sort
          description: Sort by 'new' or 'hot'
          schema: { type: string, default: new }
      responses:
        "200":
          description: Posts page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePagePosts"
    post:
      tags: [Community]
      summary: Create a post
      operationId: communityPostsCreate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PostCreateRequest"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePostCreateResult"

  /api/v1/community/posts/{postId}:
    get:
      tags: [Community]
      summary: Get post detail
      operationId: communityPostsGet
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Post detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePost"
    patch:
      tags: [Community]
      summary: Update a post
      operationId: communityPostsUpdate
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PostPatchRequest"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePost"
    delete:
      tags: [Community]
      summary: Delete a post (soft delete)
      operationId: communityPostsDelete
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"

  /api/v1/community/posts/{postId}/comments:
    get:
      tags: [Community]
      summary: List comments for a post
      operationId: communityPostCommentsList
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20 }
      responses:
        "200":
          description: Comments
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseComments"
    post:
      tags: [Community]
      summary: Add comment to a post
      operationId: communityPostCommentsAdd
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommentCreateRequest"
      responses:
        "200":
          description: Added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseCommentCreate"

  /api/v1/community/comments/{commentId}:
    delete:
      tags: [Community]
      summary: Delete a comment
      operationId: communityCommentDelete
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: commentId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"

  /api/v1/community/posts/{postId}/like:
    post:
      tags: [Community]
      summary: Like a post
      operationId: communityPostLike
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
    delete:
      tags: [Community]
      summary: Unlike a post
      operationId: communityPostUnlike
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"

  /api/v1/community/posts/{postId}/bookmark:
    post:
      tags: [Community]
      summary: Bookmark a post
      operationId: communityPostBookmark
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
    delete:
      tags: [Community]
      summary: Remove bookmark
      operationId: communityPostUnbookmark
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"

  /api/v1/community/reports:
    post:
      tags: [Community]
      summary: Report content
      operationId: communityReport
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReportRequest"
      responses:
        "200":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseReportResult"

  /api/v1/community/search:
    get:
      tags: [Community]
      summary: Search community posts/records
      operationId: communitySearch
      parameters:
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: tag
          schema: { type: string }
        - in: query
          name: type
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 10 }
      responses:
        "200":
          description: Search result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePageSearchResults"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    # Community search/result schemas
    SearchResultItem:
      type: object
      properties:
        recordId: { type: integer }
        title: { type: string }
    ApiResponsePageSearchResults:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/SearchResultItem" }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }

    # Community posts core schemas
    PostSummary:
      type: object
      properties:
        id: { type: integer }
        authorId: { type: integer }
        authorNickname: { type: string }
        title: { type: string, nullable: true }
        excerpt: { type: string }
        shareType: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        likeCount: { type: integer }
        commentCount: { type: integer }
    PostShareReference:
      type: object
      properties:
        refType: { type: string, example: record }
        refId: { type: integer }
        snapshot: { type: object }
    PostAttachment:
      type: object
      properties:
        url: { type: string }
        mimeType: { type: string }
        width: { type: integer }
        height: { type: integer }
    Post:
      type: object
      properties:
        id: { type: integer }
        authorId: { type: integer }
        authorNickname: { type: string }
        title: { type: string, nullable: true }
        content: { type: string }
        shareReference:
          $ref: "#/components/schemas/PostShareReference"
        attachments:
          type: array
          items: { $ref: "#/components/schemas/PostAttachment" }
        tags:
          type: array
          items: { type: string }
        likeCount: { type: integer }
        commentCount: { type: integer }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time, nullable: true }
    PostCreateRequest:
      type: object
      required: [content]
      properties:
        title: { type: string }
        content: { type: string }
        shareType: { type: string, nullable: true }
        shareRefId: { type: integer, nullable: true }
        tags:
          type: array
          items: { type: string }
    PostPatchRequest:
      type: object
      properties:
        title: { type: string }
        content: { type: string }
        tags:
          type: array
          items: { type: string }
    ApiResponsePagePosts:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/PostSummary" }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }
    ApiResponsePost:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data: { $ref: "#/components/schemas/Post" }
    ApiResponsePostCreateResult:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: 创建成功 }
        data:
          type: object
          properties:
            postId: { type: integer }

    # Comments & report schemas used by community
    Comment:
      type: object
      properties:
        id: { type: integer }
        type: { type: string }
        content: { type: string }
    CommentCreateRequest:
      type: object
      properties:
        type: { type: string, example: danmu }
        step: { type: integer }
        content: { type: string }
    ApiResponseComments:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: array
          items: { $ref: "#/components/schemas/Comment" }
    ApiResponseCommentCreate:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            commentId: { type: integer }
    ReportRequest:
      type: object
      properties:
        targetType: { type: string, example: share }
        targetId: { type: integer }
        reason: { type: string }
    ApiResponseReportResult:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: 已受理 }
        data:
          type: object
          properties:
            reportId: { type: integer }
    # Boards schemas
    Board:
      type: object
      properties:
        id: { type: integer, example: 301 }
        name: { type: string, example: 中炮对屏风马 }
        description: { type: string, nullable: true }
        layout:
          type: object
          properties:
            pieces:
              type: array
              items:
                type: object
                properties:
                  type: { type: string, example: car }
                  x: { type: integer }
                  y: { type: integer }
                  side: { type: string, enum: [red, black] }
        rules:
          $ref: "#/components/schemas/Rules"
    BoardTemplate:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: 中炮对屏风马 }
        preview: { type: string, example: /img/t1.png }
    BoardCreateRequest:
      type: object
      required: [name, layout]
      properties:
        name: { type: string }
        description: { type: string, nullable: true }
        layout: { type: object }
        rules:
          $ref: "#/components/schemas/Rules"
    BoardUpdateRequest:
      type: object
      properties:
        name: { type: string }
        description: { type: string, nullable: true }
        layout: { type: object }
        rules:
          $ref: "#/components/schemas/Rules"
    ApiResponseBoardTemplates:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: array
          items: { $ref: "#/components/schemas/BoardTemplate" }
    ApiResponsePageBoardTemplates:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/BoardTemplate" }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }
    ApiResponseBoardCreateResult:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: 创建成功 }
        data:
          type: object
          properties:
            boardId: { type: integer, example: 301 }
            name: { type: string }
    ApiResponsePageBoards:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/Board" }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }
    ApiResponseBoard:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data: { $ref: "#/components/schemas/Board" }
    ApiResponseAvatar:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: 上传成功 }
        data:
          type: object
          properties:
            url: { type: string }

    # Battles schemas
    Battle:
      type: object
      properties:
        battleId: { type: integer, example: 501 }
        status: { type: string, example: waiting }
        mode: { type: string, example: pvp }
        players:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
        moves:
          type: array
          items: { type: object }
    BattleCreateRequest:
      type: object
      properties:
        mode: { type: string, example: pvp }
        initialBoardId: { type: integer }
        fogMode: { type: boolean }
        password: { type: string, nullable: true }
    BattleJoinRequest:
      type: object
      required: [battleId]
      properties:
        battleId: { type: integer }
        password: { type: string, nullable: true }
    BattleMatchRequest:
      type: object
      properties:
        mode: { type: string, example: pvp }
    BattleHistoryItem:
      type: object
      properties:
        battleId: { type: integer }
        result: { type: string, example: win }
    ApiResponseBattleCreateResult:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: 房间创建成功 }
        data:
          type: object
          properties:
            battleId: { type: integer }
            status: { type: string }
    ApiResponseBattleMatchResult:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: 匹配成功 }
        data:
          type: object
          properties:
            battleId: { type: integer }
    ApiResponseBattle:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data: { $ref: "#/components/schemas/Battle" }
    ApiResponsePageBattleHistory:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/BattleHistoryItem" }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }

    # Records schemas
    Record:
      type: object
      properties:
        id: { type: integer }
        battleId: { type: integer }
        opponent: { type: string, nullable: true }
        startedAt: { type: string, format: date-time, nullable: true }
        endedAt: { type: string, format: date-time, nullable: true }
        result: { type: string, nullable: true, example: red }
        endReason: { type: string, nullable: true, example: checkmate }
        keyTags:
          type: array
          items: { type: string }
        initialLayout:
          type: object
          description: "起始布局（残局/自定义棋局），如 { pieces: [{type, side, x, y}] }"
          properties:
            pieces:
              type: array
              items:
                type: object
                properties:
                  type: { type: string }
                  side: { type: string, enum: [red, black] }
                  x: { type: integer }
                  y: { type: integer }
        favorite: { type: boolean, default: false }
        moves:
          type: array
          items: { $ref: "#/components/schemas/RecordMove" }
        bookmarks:
          type: array
          items: { $ref: "#/components/schemas/Bookmark" }
        shared: { type: boolean, default: false }
        createdAt: { type: string, format: date-time, nullable: true }
        updatedAt: { type: string, format: date-time, nullable: true }
    RecordMove:
      type: object
      properties:
        moveIndex: { type: integer }
        from:
          type: object
          properties: { x: { type: integer }, y: { type: integer } }
        to:
          type: object
          properties: { x: { type: integer }, y: { type: integer } }
        piece:
          type: object
          properties:
            type: { type: string }
            side: { type: string, enum: [red, black] }
        capturedType: { type: string, nullable: true }
        capturedSide: { type: string, nullable: true }
        timeSpentMs: { type: integer, nullable: true }
    Bookmark:
      type: object
      properties:
        id: { type: integer }
        step: { type: integer }
        label: { type: string, nullable: true }
        note: { type: string, nullable: true }
        createdAt: { type: string, format: date-time, nullable: true }
        updatedAt: { type: string, format: date-time, nullable: true }
    RecordCreateRequest:
      type: object
      properties:
        opponent: { type: string, nullable: true }
        startedAt: { type: string, format: date-time, nullable: true }
        endedAt: { type: string, format: date-time, nullable: true }
        result: { type: string, nullable: true }
        endReason: { type: string, nullable: true }
        keyTags:
          type: array
          items: { type: string }
        initialLayout:
          type: object
          description: "起始布局（残局/自定义棋局），如 { pieces: [{type, side, x, y}] }"
          properties:
            pieces:
              type: array
              items:
                type: object
                properties:
                  type: { type: string }
                  side: { type: string, enum: [red, black] }
                  x: { type: integer }
                  y: { type: integer }
        moves:
          type: array
          items: { $ref: "#/components/schemas/RecordMove" }
        bookmarks:
          type: array
          items: { $ref: "#/components/schemas/Bookmark" }
    RecordUpdateRequest:
      type: object
      properties:
        opponent: { type: string }
        result: { type: string }
        endReason: { type: string }
        keyTags:
          type: array
          items: { type: string }
    BookmarkCreateRequest:
      type: object
      required: [step]
      properties:
        step: { type: integer }
        label: { type: string, nullable: true }
        note: { type: string, nullable: true }
    BookmarkUpdateRequest:
      type: object
      properties:
        step: { type: integer }
        label: { type: string, nullable: true }
        note: { type: string, nullable: true }
    ShareRequest:
      type: object
      properties:
        title: { type: string }
        tags:
          type: array
          items: { type: string }
    ApiResponsePageRecords:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/Record" }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }
    ApiResponseRecord:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data: { $ref: "#/components/schemas/Record" }
    ApiResponseBookmarkCreate:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            id: { type: integer }
    ApiResponseShareResult:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            shareId: { type: integer, example: 9001 }
            url: { type: string, nullable: true, example: "/shares/9001" }

    # Record preferences schemas
    RecordPrefs:
      type: object
      properties:
        keepLimit: { type: integer, example: 30, minimum: 1, maximum: 500 }
    RecordPrefsPatch:
      type: object
      properties:
        keepLimit: { type: integer, minimum: 1, maximum: 500 }
    ApiResponseRecordPrefs:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data: { $ref: "#/components/schemas/RecordPrefs" }

    # Board rule editor schemas
    Rules:
      type: object
      description: 自定义棋局规则（编辑器用），支持模板与图形化自定义
      required: [layoutSource, pieceRules]
      properties:
        ruleVersion: { type: integer, minimum: 1, maximum: 100, default: 1 }
        layoutSource:
          type: string
          enum: [empty, standard, template]
        templateRefId: { type: integer, nullable: true }
        coordinateSystem:
          type: string
          enum: [relativeToSide, absolute]
          default: relativeToSide
        mode:
          type: string
          enum: [analysis, localVersus]
          default: analysis
        pieceRules:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/PieceRuleConfig"
        notes: { type: string, maxLength: 200, nullable: true }
        templatesUsed:
          type: array
          items: { type: string }
    PieceRuleConfig:
      type: object
      required: [ruleType]
      properties:
        ruleType: { type: string, enum: [template, custom] }
        templateKey: { type: string, nullable: true }
        movement: { $ref: "#/components/schemas/MoveSpec" }
        captureMode:
          { type: string, enum: [sameAsMove, separate], default: sameAsMove }
        capture: { $ref: "#/components/schemas/MoveSpec" }
        constraints: { $ref: "#/components/schemas/ConstraintsSpec" }
    MoveSpec:
      type: object
      properties:
        rays:
          type: array
          items: { $ref: "#/components/schemas/RaySpec" }
        steps:
          type: array
          items: { $ref: "#/components/schemas/StepSpec" }
        gridMask:
          type: array
          items:
            type: array
            items: { type: integer }
            minItems: 2
            maxItems: 2
        maxDestinations: { type: integer, minimum: 1 }
    RaySpec:
      type: object
      properties:
        directions:
          type: array
          items:
            type: string
            enum: [N, S, E, W, NE, NW, SE, SW]
        vectors:
          type: array
          items:
            type: array
            items: { type: integer }
            minItems: 2
            maxItems: 2
        maxSteps: { type: integer, minimum: 1, nullable: true }
        requireScreensForMove:
          { type: integer, minimum: 0, maximum: 2, default: 0 }
        requireScreensForCapture:
          { type: integer, minimum: 0, maximum: 2, default: 0 }
        stopAtFirstBlocker: { type: boolean, default: true }
    StepSpec:
      type: object
      properties:
        offset:
          type: array
          items: { type: integer }
          minItems: 2
          maxItems: 2
        requiredEmpty:
          type: array
          items:
            type: array
            items: { type: integer }
            minItems: 2
            maxItems: 2
        allowCapture: { type: boolean, default: true }
    ConstraintsSpec:
      type: object
      properties:
        palace:
          { type: string, enum: [none, insideOnly, outsideOnly], default: none }
        river:
          { type: string, enum: [none, cannotCross, mustCross], default: none }
        forwardOnlyBeforeRiver: { type: boolean }
        enableSidewaysAfterRiver: { type: boolean }
        allowBackwardAfterRiver: { type: boolean }

    # Legacy/utility community list schemas
    CommunityShareItem:
      type: object
      properties:
        shareId: { type: integer }
        title: { type: string }
        likes: { type: integer }
    ApiResponsePageCommunityShares:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/CommunityShareItem" }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }

    # Auth & Users schemas
    ApiResponseUser:
      type: object
      properties:
        code:
          type: integer
          example: 0
        message:
          type: string
          example: success
        data:
          $ref: "#/components/schemas/User"
      required: [code, message, data]
    ApiResponseError:
      type: object
      properties:
        code:
          type: integer
          example: 1001
        message:
          type: string
          example: 参数错误
        data:
          oneOf:
            - type: "null"
            - type: object
              description: 参数校验错误详情
              properties:
                details:
                  type: array
                  items: { type: string }
      required: [code, message]
    AuthRegisterRequest:
      type: object
      required: [type, phone, password]
      properties:
        type:
          type: string
          enum: [phone]
          default: phone
        phone:
          type: string
          example: "13800000000"
        code:
          type: string
          description: SMS verification code (optional if disabled)
          example: "8523"
        password:
          type: string
          format: password
          minLength: 6
          example: Abc12345
        email:
          type: string
          format: email
          nullable: true
    AuthLoginRequest:
      type: object
      required: [type, phone, password]
      properties:
        type:
          type: string
          enum: [phone]
          default: phone
        phone:
          type: string
          example: "13800000000"
        password:
          type: string
          format: password
          example: Abc12345
    AuthRefreshRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken:
          type: string
          example: eyJhbGciOi...
    AuthTokens:
      type: object
      properties:
        accessToken:
          type: string
          description: JWT access token
          example: eyJhbGciOi...
        refreshToken:
          type: string
          description: JWT refresh token
          example: eyJhbGciOi...
        expiresIn:
          type: integer
          description: Access token TTL in seconds
          example: 1800
      required: [accessToken, refreshToken]
    ApiResponseAuthTokens:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data: { $ref: "#/components/schemas/AuthTokens" }
      required: [code, message, data]
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1024
        nickname:
          type: string
          example: 棋友A
        phone:
          type: string
          example: "13800000000"
        avatarUrl:
          type: string
          nullable: true
        role:
          type: string
          enum: [USER, ADMIN]
        createdAt:
          type: string
          format: date-time
    UserUpdateRequest:
      type: object
      properties:
        nickname: { type: string }
        password: { type: string, format: password, minLength: 6 }
        avatarUrl: { type: string }
    SmsRequest:
      type: object
      required: [phone]
      properties:
        phone: { type: string, example: "13800000000" }
    ApiResponseSmsSent:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: 短信已发送 }
        data:
          type: object
          properties:
            requestId: { type: string, example: sms_9f3a2 }
            expireIn: { type: integer, example: 300 }
      required: [code, message]
    ApiResponseOk:
      type: object
      properties:
        code: { type: integer, example: 0 }
        message: { type: string, example: success }
        data: { type: object, nullable: true }
