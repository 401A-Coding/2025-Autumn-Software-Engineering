# 可视化规则编辑器使用指南

## 🎯 功能概述

可视化规则编辑器提供了一种直观的方式来定义象棋棋子的移动规则。通过在9x9的简易棋盘上点击选择，你可以轻松创建自定义的移动模式。

## 📍 访问路径

- **路由**: `/app/visual-editor`
- **入口**: 主页 → 自定义棋局 → 🎨 可视化编辑器

## 🎨 界面说明

### 左侧面板

#### 1. 选择棋子
- 7个棋子类型可选：将/帅、士/仕、象/相、马、车、炮、兵/卒
- 点击选择要编辑规则的棋子
- 当前选中的棋子会高亮显示

#### 2. 编辑模式
- **➕ 添加模式**: 点击棋盘格子来添加移动位置
- **➖ 删除模式**: 点击已选格子来删除移动位置

#### 3. 移动类型
- **移动和吃子**: 既可以移动到空格，也可以吃子（默认）
- **仅移动**: 只能移动到空格，不能吃子
- **仅吃子**: 只能吃子，不能移动到空格

#### 4. 高级选项
- **可重复移动**: 勾选后，棋子可以沿该方向连续移动
  - 例如：车选择向右一格+可重复 = 车可以向右移动任意步

#### 5. 操作按钮
- **📥 加载当前规则**: 将该棋子现有的规则显示在棋盘上
- **🗑️ 清除选择**: 清空棋盘上所有选择的格子
- **✅ 应用规则**: 将棋盘上的选择应用为该棋子的规则

### 中间棋盘

#### 棋盘说明
- **9x9格子**: 简化的象棋棋盘
- **红色中心格**: 表示当前棋子的位置（不可选）
- **绿色格子**: 已选择的移动目标位置
- **蓝色圆点**: 标记可移动到的位置

#### 坐标系统
- 中心点为 (0, 0)
- 向右为正X方向
- 向下为正Y方向
- 例如：中心右侧一格为 (1, 0)，中心下方一格为 (0, 1)

### 右侧面板

#### 当前规则预览
- 实时显示当前棋子的规则JSON
- 包含所有移动模式的详细配置

## 🚀 使用流程

### 基础流程

1. **选择棋子** - 点击左侧棋子按钮
2. **切换到添加模式** - 确保"添加"按钮被选中
3. **在棋盘上点击** - 选择该棋子可以移动到的位置
4. **设置移动类型** - 选择"移动和吃子"、"仅移动"或"仅吃子"
5. **（可选）勾选可重复** - 如果需要连续移动能力
6. **应用规则** - 点击"✅ 应用规则"按钮
7. **保存** - 点击"💾 保存所有规则"

### 高级流程

#### 编辑现有规则
1. 选择棋子
2. 点击"📥 加载当前规则"
3. 修改选择（添加或删除格子）
4. 点击"✅ 应用规则"

#### 创建车类移动
1. 选择棋子（如车）
2. 在中心点的上、下、左、右各选择一格
3. **勾选"可重复移动"**
4. 应用规则
→ 结果：棋子可以沿四个方向无限移动

#### 创建马类移动
1. 选择马
2. 在8个"日"字位置点击选择
3. **不勾选"可重复移动"**
4. 应用规则
→ 结果：马可以跳"日"字

## 📋 实战示例

### 示例1: 标准兵

**目标**: 未过河只能前进1步，过河后可左右移动

**步骤**:
1. 选择"兵/卒"
2. 在中心点上方选择1格（前进）
3. 不勾选"可重复"
4. 应用规则

**注意**: 标准兵的过河逻辑需要使用"条件规则系统"

### 示例2: 超级车

**目标**: 可以沿八个方向移动

**步骤**:
1. 选择"车"
2. 在中心点的上、下、左、右、左上、右上、左下、右下各选1格
3. **勾选"可重复移动"**
4. 应用规则

### 示例3: 短程马

**目标**: 只能走"日"字，但不能连续跳

**步骤**:
1. 选择"马"
2. 在8个日字位置点击
3. 不勾选"可重复"
4. 应用规则

### 示例4: 飞将

**目标**: 可以向前飞行任意距离

**步骤**:
1. 选择"将/帅"
2. 在中心点上方选择1格
3. **勾选"可重复移动"**
4. 移动类型选择"移动和吃子"
5. 应用规则

### 示例5: 定向炮

**目标**: 只能向右吃子，不能移动

**步骤**:
1. 选择"炮"
2. 在中心点右侧选择1格
3. 移动类型选择"仅吃子"
4. 勾选"可重复"
5. 应用规则

## ⚙️ 技术说明

### 数据结构

生成的规则格式：
```typescript
{
  name: "车",
  movePatterns: [
    {
      dx: 1,      // X方向偏移
      dy: 0,      // Y方向偏移
      repeat: true,  // 可重复
      maxSteps: 0,   // 最大步数（0=无限）
      moveOnly: false,    // 仅移动
      captureOnly: false  // 仅吃子
    }
  ],
  restrictions: {}
}
```

### 坐标转换

棋盘中心 (4, 4) = 棋子位置
- 点击 (5, 4) → dx = 1, dy = 0 (向右)
- 点击 (4, 3) → dx = 0, dy = -1 (向上)
- 点击 (3, 5) → dx = -1, dy = 1 (左下)

### 存储机制

- 规则保存在 `localStorage` 的 `customRuleSet` 键
- 自动合并标准规则，确保完整性
- 每个棋子独立配置

## 🎮 开始对局

配置完规则后：
1. 点击"💾 保存所有规则"保存配置
2. 点击"▶️ 开始对局"进入自定义对局
3. 在对局中，所有棋子将使用你定义的规则

## ⚠️ 注意事项

### 常见问题

1. **规则不生效**
   - 确保点击了"✅ 应用规则"
   - 确保点击了"💾 保存所有规则"

2. **棋子移动范围不对**
   - 检查是否勾选了"可重复移动"
   - 检查移动类型是否正确

3. **无法点击中心格**
   - 中心格代表棋子位置，不能作为目标

4. **规则被重置**
   - 加载预设会覆盖自定义规则
   - 建议先备份规则JSON

### 最佳实践

1. **逐个编辑**: 一次只编辑一个棋子，避免混淆
2. **及时保存**: 完成一个棋子后立即保存
3. **加载测试**: 使用"加载当前规则"验证保存结果
4. **对称设计**: 对称的移动模式（如马）更易于理解
5. **先测试**: 在简单配置下先测试，确认无误后再复杂化

## 🔧 高级技巧

### 创建组合规则

**场景**: 创建既能近战又能远程的棋子

1. 选择近战位置（如四周8格）
2. 应用规则
3. 再选择远程位置（如某个方向+可重复）
4. 应用规则

**问题**: 第二次应用会覆盖第一次

**解决**: 使用高级编辑器的多模式功能，或一次性选择所有位置

### 批量配置

为多个棋子应用相同规则：
1. 配置第一个棋子
2. 记录规则JSON（从预览中复制）
3. 在浏览器控制台手动设置其他棋子：
```javascript
const rules = JSON.parse(localStorage.getItem('customRuleSet'))
rules.pieceRules['advisor'] = rules.pieceRules['rook']
localStorage.setItem('customRuleSet', JSON.stringify(rules))
```

## 📚 相关资源

- **高级编辑器**: `/app/custom-editor` - 提供模板和更多选项
- **对局页面**: `/app/custom-battle` - 使用自定义规则对弈
- **条件规则系统**: 查看 `CONDITIONAL_RULES_GUIDE.md` 了解位置条件规则

## 🆘 故障排除

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| 点击无反应 | 编辑模式错误 | 检查是否在"添加"模式 |
| 规则丢失 | 未保存 | 记得点"保存所有规则" |
| 棋子不动 | 规则为空 | 至少选择一个移动位置 |
| 移动范围小 | 未勾选重复 | 勾选"可重复移动" |
| 无法吃子 | 类型错误 | 移动类型改为"移动和吃子" |

---

**提示**: 可视化编辑器适合快速创建简单规则。如需复杂条件（如过河、九宫限制），请使用高级编辑器或条件规则系统。
