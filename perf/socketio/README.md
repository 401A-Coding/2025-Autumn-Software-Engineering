# Socket.IO 压力测试

使用原生 `socket.io-client` 实现的真实 WebSocket 连接压力测试脚本。

## 安装依赖

```bash
cd perf/socketio
npm install
```

依赖项：

- `socket.io-client` v4.7.0 - WebSocket 客户端
- `axios` v1.6.0 - HTTP 客户端

## 测试脚本

### 1. multi-room-test.js - 多房间实战测试 ✅ 推荐

**适用场景**：模拟真实对战场景，每对战使用两个不同账号

**特点**：

- ✅ 创建独立对战房间
- ✅ 两个真实账号对战（红方 vs 黑方）
- ✅ 使用真实象棋规则走法
- ✅ 自动处理频率限制（500ms 间隔）
- ✅ 100% 走棋成功率验证

**使用方法**：

```bash
# PowerShell
cd perf/socketio

# 快速测试：1对对局，每方走2步
$env:PAIRS='1'; $env:MOVES='2'; node multi-room-test.js

# 标准测试：3对对局，每方走3步
$env:PAIRS='3'; $env:MOVES='3'; node multi-room-test.js

# 压力测试：5对对局，每方走5步
$env:PAIRS='5'; $env:MOVES='5'; node multi-room-test.js
```

```bash
# Linux/macOS
cd perf/socketio

PAIRS=1 MOVES=2 node multi-room-test.js
PAIRS=3 MOVES=3 node multi-room-test.js
PAIRS=5 MOVES=5 node multi-room-test.js
```

**配置参数**：

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `BASE_URL` | `http://101.42.118.61` | 服务器地址 |
| `PHONE1` | `13053083296` | 红方玩家账号 |
| `PASSWORD1` | `123456` | 红方玩家密码 |
| `PHONE2` | `13035096178` | 黑方玩家账号 |
| `PASSWORD2` | `123456` | 黑方玩家密码 |
| `PAIRS` | `5` | 对战对数 |
| `MOVES` | `3` | 每方走棋次数 |

### 2. load-test.js - 单房间连接测试

**适用场景**：测试大量客户端同时连接单个房间的性能

**限制**：使用同一个用户账号，无法真正进入 `playing` 状态，走棋测试会被跳过

**使用方法**：

```bash
# PowerShell
$env:CLIENTS='50'; $env:DURATION='60'; node load-test.js

# Linux/macOS
CLIENTS=50 DURATION=60 node load-test.js
```

**预设场景**：

```bash
# 轻量测试：10个客户端，30秒
npm run test:light

# 中等测试：50个客户端，60秒
npm run test:medium

# 重载测试：100个客户端，120秒
npm run test:heavy
```

**配置参数**：

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `BATTLE_ID` | `23165` | 测试房间ID |
| `CLIENTS` | `50` | 并发客户端数量 |
| `RAMP_UP` | `10` | 启动时间（秒） |
| `DURATION` | `60` | 测试持续时间（秒） |

## 测试流程

### multi-room-test.js 流程

每对对战执行：

1. **登录**：红方和黑方分别登录获取 JWT token
2. **创建房间**：红方创建新的 battle 房间
3. **Socket.IO 连接**：双方连接到 `/battle` namespace，认证 token
4. **加入房间**：双方发送 `battle.join` 事件进入同一房间
5. **等待状态**：等待房间状态变为 `playing`
6. **交替走棋**：红黑双方按真实象棋规则交替走棋
7. **断开连接**：对战结束后关闭连接

### load-test.js 流程

每个虚拟客户端执行：

1. **HTTP 登录**：调用 `/api/v1/auth/login` 获取 JWT token
2. **Socket.IO 连接**：连接到 `/battle` namespace，认证 token
3. **加入房间**：发送 `battle.join` 事件
4. **保持连接**：维持连接直到测试结束

## 象棋走法规则

测试脚本使用真实象棋规则坐标：

### 棋盘坐标系统

- **x 轴**：0-8（共9列），兵/卒位于 x = 0, 2, 4, 6, 8
- **y 轴**：0-9（共10行）
  - 红方底部：y = 6-9
  - 黑方顶部：y = 0-3

### 预设走法序列

**红方**（依次移动5个兵）：

1. 中兵：(4,6) → (4,5)
2. 2路兵：(2,6) → (2,5)
3. 6路兵：(6,6) → (6,5)
4. 0路兵：(0,6) → (0,5)
5. 8路兵：(8,6) → (8,5)

**黑方**（依次移动5个卒）：

1. 中卒：(4,3) → (4,4)
2. 2路卒：(2,3) → (2,4)
3. 6路卒：(6,3) → (6,4)
4. 0路卒：(0,3) → (0,4)
5. 8路卒：(8,3) → (8,4)

> 更多步数时会让已移动的兵/卒继续前进一格

## 性能基准

### multi-room-test.js 测试结果

**测试配置**：5对对局，每对10步走棋（总共50步）

**结果**（31.94秒）：

- ✅ **走棋成功率**：100% (50/50)
- ⚡ **登录**：229ms 平均
- ⚡ **创建房间**：41ms 平均
- ⚡ **Socket.IO 连接**：30ms 平均
- ⚡ **加入房间**：10ms 平均
- ⚡ **走棋**：10ms 平均

## 重要说明

### 频率限制

后端有走棋频率限制，需要在走棋之间添加至少 **500ms** 的延迟，否则会收到 `move rate limit exceeded` 错误。

### 双账号要求

`multi-room-test.js` 需要两个不同的测试账号：

- **红方**：PHONE1 / PASSWORD1（默认：13053083296 / 123456）
- **黑方**：PHONE2 / PASSWORD2（默认：13035096178 / 123456）

确保这两个账号在测试前已注册。

### 测试模式

- **串行执行**：对战逐对执行，避免并发冲突
- **独立房间**：每对对战创建新的 battle 房间
- **真实走法**：使用符合象棋规则的合法走棋

## 输出示例

```
========================================
Socket.IO 多房间压力测试
========================================
目标服务器: http://101.42.118.61
玩家1账号: 13053083296
玩家2账号: 13035096178
对战对数: 3
每对战走棋次数: 6
========================================

[对局 1] 创建房间 ID=54
[对局 1] 玩家1已加入
[对局 1] 玩家2已加入
[对局 1] 两名玩家已加入，开始对战
[对局 1] 红方走棋成功 (1/3): (4,6)→(4,5)
[对局 1] 黑方走棋成功 (1/3): (4,3)→(4,4)
...
[对局 1] 完成 6 步走棋

========================================
测试结果
========================================
总耗时: 9.85秒

登录 (Login):
  成功: 6
  失败: 0
  平均响应时间: 241.67ms

创建房间 (Create Battle):
  成功: 3
  失败: 0
  平均响应时间: 57.00ms

Socket.IO 连接 (Connect):
  成功: 6
  失败: 0
  平均连接时间: 25.83ms

加入房间 (Join):
  成功: 6
  失败: 0
  平均响应时间: 10.00ms

走棋 (Move):
  成功: 12
  失败: 0
  平均响应时间: 9.08ms

走棋完成率: 100.00% (12/12)
========================================
```

## 故障排查

### 连接失败

```
connect_error: websocket error
```

**原因**：

- 服务器 Socket.IO 服务未运行
- 认证 token 无效
- 网络连接问题

**解决**：

1. 检查服务器状态
2. 验证账号密码正确
3. 确认服务器地址可访问

### 走棋失败

```
move_exception: Internal server error
```

**原因**：

- 走法不符合象棋规则
- 棋子位置错误
- 不是当前玩家回合

**解决**：

1. 使用预设的合法走法序列
2. 确保两个玩家账号不同
3. 检查后端日志了解详细错误

### 频率限制

```
move_exception: move rate limit exceeded
```

**原因**：走棋速度过快，触发后端限流

**解决**：脚本已内置 500ms 延迟，无需额外处理

## 与其他工具对比

| 工具 | 用途 | 优势 | 限制 |
|------|------|------|------|
| **perf/socketio/** | Socket.IO 实战测试 | 真实 WebSocket，双账号对战，象棋规则 | 需要 Node.js |
| **Artillery** | HTTP API 压测 | 配置简单，YAML 格式 | Socket.IO 不支持认证 |
| **k6** | HTTP API 压测 | 高性能，编程灵活 | Socket.IO 需要特殊构建 |

## 扩展建议

1. **添加监听事件**：监听 `battle.snapshot`、`battle.move` 广播
2. **并发对战**：修改为并行执行多对战（需要更多账号）
3. **性能指标**：集成 Prometheus metrics
4. **结果导出**：输出 JSON 格式报告
5. **更多走法**：添加车、马、炮等复杂棋子的走法

## 安全提示

⚠️ **不要在生产环境运行高负载测试**，可能影响真实用户
⚠️ 使用独立的测试账号，不要使用真实用户账号
⚠️ 测试后建议清理或重置测试房间数据
